<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTRACTX — Converter</title>

  <style>
    :root{
      --bg:#070A0F;
      --stroke:rgba(255,255,255,.12);
      --stroke2:rgba(255,255,255,.22);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.65);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --warn:#FFD66E;
      --pill:rgba(255,255,255,.07);
      --pill2:rgba(255,255,255,.10);
      --good:#7CFFB2;
      --bad:#FF7C7C;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(40,110,255,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(255,215,80,.12), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:22px;
    }
    h1{margin:0;font-size:26px}
    .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.45}

    .row{
      margin-top:18px;
      display:grid;
      grid-template-columns:1.05fr .95fr;
      gap:14px;
    }
    @media(max-width:900px){.row{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.25);
      padding:16px;
    }

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background:rgba(0,0,0,.35);
      color:var(--text);
      font-size:15px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(234,240,255,.35)}

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.two{grid-template-columns:1fr}}

    .btn{
      margin-top:10px;
      padding:11px 14px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      transition:.15s ease;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}

    .big{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:16px;
      background:rgba(0,0,0,.35);
    }
    .big .t{font-size:12px;color:var(--muted)}
    .big .v{font-size:28px;font-weight:900;margin-top:6px}

    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:520px){.kv{grid-template-columns:1fr}}

    .note{margin-top:12px;font-size:12px;color:var(--muted);line-height:1.45}
    .warn{
      margin-top:12px;
      border:1px solid rgba(255,214,110,.35);
      background:rgba(255,214,110,.08);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:var(--warn);
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px;
      padding:6px;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(0,0,0,.30);
      width:max-content;
    }
    .tab{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
    }
    .tab.active{
      background:rgba(255,255,255,.10);
      border-color:var(--stroke2);
      color:var(--text);
    }

    .tvTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tfRow{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--pill);
      color:var(--text);
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{background:var(--pill2)}
    .pill.secondary{color:var(--muted);font-weight:700}
    .pill.active{background:rgba(255,255,255,.14);border-color:var(--stroke2)}

    .tvbox{height:560px;border-radius:16px;overflow:hidden}

    /* Notes UI */
    .notesTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:10px;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(0,0,0,.28);
      margin-top:12px;
      align-items:center;
    }
    .tool{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .tool:hover{background:rgba(255,255,255,.10)}

    .editor{
      margin-top:10px;
      border:1px solid var(--stroke2);
      border-radius:16px;
      background:rgba(0,0,0,.35);
      padding:14px;
      min-height:180px;
      outline:none;
      line-height:1.45;
      color:var(--text);
      overflow:auto;
      white-space:pre-wrap;
    }
    .editor:empty:before{
      content:attr(data-placeholder);
      color:rgba(234,240,255,.35);
      white-space:pre-wrap;
    }

    .divider{
      height:1px;
      background:rgba(255,255,255,.10);
      margin:14px 0;
      border-radius:999px;
    }
    .hidden{display:none !important}

    /* Rating stars */
    .stars{display:flex;gap:6px;align-items:center}
    .star{
      width:22px;height:22px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--stroke);
      border-radius:8px;
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:rgba(234,240,255,.55);
    }
    .star.active{color:var(--text);background:rgba(255,255,255,.12);border-color:var(--stroke2)}

    .kpiRow{
      display:grid;
      grid-template-columns:1fr 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:900px){.kpiRow{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.kpiRow{grid-template-columns:1fr}}
    .kpi{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(0,0,0,.22);
    }
    .kpi .k{font-size:12px;color:var(--muted);font-weight:900}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:950}
    .v.good{color:var(--good)}
    .v.bad{color:var(--bad)}

    /* Playbook cards */
    .pbGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:900px){.pbGrid{grid-template-columns:1fr}}
    .pbCard{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.22);
    }
    .pbTitle{
      font-weight:950;
      font-size:13px;
      margin-bottom:8px;
    }
    .pbOpts{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .opt{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color:var(--text);
    }
    .opt input{width:14px;height:14px;margin:0}
    .opt:hover{background:rgba(255,255,255,.08)}
    .pbHint{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35}

    /* Image slots */
    .imgGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:720px){.imgGrid{grid-template-columns:1fr}}
    .imgSlot{
      border:1px dashed rgba(255,255,255,.25);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.20);
      min-height:160px;
      position:relative;
      overflow:hidden;
    }
    .imgSlot.drag{border-color:rgba(124,255,178,.60);background:rgba(124,255,178,.06)}
    .imgSlot .cap{font-size:12px;color:var(--muted);font-weight:900}
    .imgSlot .help{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .imgSlot img{
      width:100%;
      height:auto;
      border-radius:12px;
      margin-top:10px;
      display:block;
    }
    .imgActions{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .mini{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .mini:hover{background:rgba(255,255,255,.10)}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <section class="panel">
      <h1 id="title">CONTRACTX Converter</h1>
      <div class="sub">
        Converter + Journal (klickbar, automatisiert): Direction, R-Multiple, Risk-$, Stars, Playbook-Formular, Images + PDF.
      </div>

      <div class="row">
        <!-- LEFT -->
        <div class="card">
          <div class="two">
            <div>
              <label>Broker</label>
              <select id="broker">
                <option>CampusFund</option>
                <option>FTMO</option>
                <option>FundingPips</option>
              </select>
            </div>
            <div>
              <label>Mode</label>
              <select id="mode">
                <option value="auto">Auto</option>
                <option value="fx">FX</option>
                <option value="offset">Offset</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Future aktuell (TradingView)</label>
              <input id="futureNow" inputmode="decimal" placeholder="z. B. 49308.45">
            </div>
            <div>
              <label>Prop aktuell (Mid)</label>
              <input id="propNow" inputmode="decimal" placeholder="z. B. 49310.65">
            </div>
          </div>

          <button class="btn" id="setOffset" type="button">Set Offset</button>

          <div class="note">
            Offset (Prop − Future): <strong id="offsetVal">—</strong>
          </div>

          <div style="margin-top:14px">
            <label>Trade-Plan (Future)</label>
            <div class="two">
              <div>
                <label style="margin-top:0">Entry</label>
                <input id="entryF" inputmode="decimal" placeholder="Entry (Future)">
              </div>
              <div>
                <label style="margin-top:0">SL</label>
                <input id="slF" inputmode="decimal" placeholder="SL (Future)">
              </div>
            </div>
            <div style="margin-top:10px">
              <label>TP</label>
              <input id="tpF" inputmode="decimal" placeholder="TP (Future)">
            </div>
          </div>

          <div class="note">
            Tipp: Prop Mid = (Bid + Ask) / 2. Offset ist session-/brokerabhängig.
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <div class="big">
            <div class="t">Prop Entry</div>
            <div class="v" id="entryP">—</div>
            <button class="btn" type="button" id="copyEntry">Copy Entry</button>
          </div>

          <div class="kv">
            <div class="big">
              <div class="t">Prop SL</div>
              <div class="v" id="slP">—</div>
              <button class="btn" type="button" id="copySL">Copy SL</button>
            </div>
            <div class="big">
              <div class="t">Prop TP</div>
              <div class="v" id="tpP">—</div>
              <button class="btn" type="button" id="copyTP">Copy TP</button>
            </div>
          </div>

          <div class="warn" id="invertHint" style="display:none">
            ⚠️ Dieses FX-Pair ist <strong>invertiert</strong><br>
            <strong>Future SHORT = FX LONG</strong><br>
            <strong>Future LONG = FX SHORT</strong>
          </div>

          <div class="note" id="chartNote"></div>
        </div>
      </div>

      <!-- Tabs + Content -->
      <div class="card" style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div class="tabs" role="tablist">
            <button class="tab active" id="tabChart" type="button">Chart</button>
            <button class="tab" id="tabNotes" type="button">Notes</button>
          </div>
          <div class="note" id="metaTop" style="margin:0"></div>
        </div>

        <!-- CHART PANEL -->
        <div id="panelChart" style="margin-top:12px">
          <div class="tvTop">
            <div class="note" style="margin:0">Live Chart (TradingView)</div>
            <div class="tfRow" id="tfRow">
              <div class="pill active" data-tf="15">15m</div>
              <div class="pill" data-tf="60">1h</div>
              <div class="pill" data-tf="240">4h</div>
              <div class="pill" data-tf="D">D</div>
            </div>
          </div>

          <div class="tvbox" style="margin-top:10px">
            <div class="tradingview-widget-container" style="height:100%;width:100%">
              <div id="tv_chart" style="height:100%;width:100%"></div>
            </div>
          </div>
        </div>

        <!-- NOTES PANEL -->
        <div id="panelNotes" class="hidden" style="margin-top:12px">
          <div class="notesTop">
            <div>
              <div style="font-weight:950">Journal</div>
              <div class="note" style="margin-top:4px">
                Alles klickbar, so wenig tippen wie möglich. PDF nimmt Daten + Playbook + Notes + Images mit.
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tool" id="btnInsertBlock" type="button">Insert summary</button>
              <button class="tool" id="btnSave" type="button">Save</button>
              <button class="tool" id="btnClear" type="button">Clear</button>
              <button class="tool" id="btnPdf" type="button">PDF</button>
              <button class="tool" id="btnPrint" type="button">Print</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="two">
            <div>
              <label>Datum / Session</label>
              <input id="jDate" placeholder="z. B. 2026-01-24 / NY Open">
            </div>
            <div>
              <label>Setup / Tags</label>
              <input id="jTags" placeholder="z. B. Globex Trap, A+, Sweep, S/D">
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Bias / Plan</label>
              <input id="jBias" placeholder="z. B. Short unter Vortages-High, Ziel EQ">
            </div>
            <div>
              <label>Instrument / Broker</label>
              <input id="jMeta" readonly>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Direction</label>
              <select id="jDir">
                <option value="auto">Auto</option>
                <option value="long">Long</option>
                <option value="short">Short</option>
              </select>
            </div>

            <div>
              <label>Risk $ (Geldbetrag)</label>
              <input id="jRiskUsd" inputmode="decimal" placeholder="z. B. 450">
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Rating</label>
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;
                          padding:10px 12px;border:1px solid var(--stroke2);border-radius:14px;background:rgba(0,0,0,.35)">
                <div class="stars" id="stars"></div>
                <div class="pill secondary" id="ratingText">—</div>
              </div>
            </div>

            <div>
              <label>CRV (manuell / Playbook)</label>
              <select id="jCrv">
                <option value="">—</option>
                <option>2:1</option>
                <option>3:1</option>
                <option>4:1</option>
                <option>4:1+</option>
              </select>
            </div>
          </div>

          <div class="kpiRow" id="kpis">
            <div class="kpi">
              <div class="k">Risk (R)</div>
              <div class="v" id="kRisk">—</div>
            </div>
            <div class="kpi">
              <div class="k">Reward</div>
              <div class="v" id="kReward">—</div>
            </div>
            <div class="kpi">
              <div class="k">R-Multiple</div>
              <div class="v" id="kRmult">—</div>
            </div>
            <div class="kpi">
              <div class="k">Offset (Prop−Future)</div>
              <div class="v" id="kOffset">—</div>
            </div>
          </div>

          <div class="warn" id="dirWarn" style="display:none">
            ⚠️ Invertiertes FX-Pair: <strong>Future SHORT = FX LONG</strong> und umgekehrt.
          </div>

          <div class="divider"></div>

          <div style="font-weight:950">Playbook (klickbar)</div>
          <div class="pbGrid" id="pbGrid"></div>

          <div class="divider"></div>

          <div style="font-weight:950">Screenshots / Images (manuell)</div>
          <div class="note" style="margin-top:6px">
            Drag & Drop oder Upload. Automatische Screenshots aus dem TradingView-Widget sind technisch blockiert (Cross-Origin).
          </div>
          <div class="imgGrid" id="imgGrid"></div>

          <div class="divider"></div>

          <div style="font-weight:950">Free Notes (optional)</div>
          <div id="editor" class="editor" contenteditable="true" spellcheck="false"
               data-placeholder="Optional. Wenn’s wichtig ist, schreib’s. Sonst reicht Playbook + KPIs."></div>

          <div class="note" id="jStatus"></div>
        </div>
      </div>
    </section>
  </div>

<script>
  // ---------- helpers ----------
  function n(v){
    if(!v) return NaN;
    return Number(String(v).replace(",", ".").trim());
  }
  function isNum(x){ return Number.isFinite(x); }
  function fmt2(x){
    if(!isNum(x)) return "—";
    return Number(x).toFixed(2);
  }

  // ---------- symbol normalize ----------
  const RAW = (new URLSearchParams(location.search).get("symbol") || "ES").toUpperCase().trim();
  const cleaned = RAW.replace(/[^A-Z0-9!]/g, "");
  function normalizeSymbol(s){
    if(!s) return "ES";
    if(s.startsWith("6")) return s.slice(0,2);
    const known3 = ["RTY"];
    const s3 = s.slice(0,3);
    if(known3.includes(s3)) return s3;
    return s.slice(0,2);
  }
  const sym = normalizeSymbol(cleaned);
  document.getElementById("title").textContent = sym + " — CONTRACTX Converter";

  // ---------- invert warning ----------
  const FX_INVERTED = ["6C","6J","6S"];
  const isInverted = FX_INVERTED.includes(sym);
  if (isInverted) document.getElementById("invertHint").style.display = "block";

  // ---------- chart map (widget-friendly) ----------
  const TV_MAP = {
    ES:  "OANDA:SPX500USD",
    NQ:  "OANDA:NAS100USD",
    YM:  "OANDA:US30USD",
    RTY: "OANDA:US2000USD",
    GC:  "TVC:GOLD",
    SI:  "TVC:SILVER",
    CL:  "TVC:USOIL",
    NG:  "TVC:NATGAS",
    "6E":"FX:EURUSD",
    "6B":"FX:GBPUSD",
    "6A":"FX:AUDUSD",
    "6N":"FX:NZDUSD",
    "6C":"FX:USDCAD",
    "6J":"FX:USDJPY",
    "6S":"FX:USDCHF"
  };
  const tvSymbol = TV_MAP[sym] || "OANDA:SPX500USD";
  document.getElementById("chartNote").textContent =
    `Chart: ${tvSymbol} (Proxy). Offset-Mapping bleibt auf deinen eingegebenen Future/Prop-Preisen.`;

  // ---------- meta ----------
  function brokerVal(){ return document.getElementById("broker")?.value || "Broker"; }
  function setMeta(){
    const meta = `${sym} • ${brokerVal()} • Chart: ${tvSymbol}`;
    document.getElementById("jMeta").value = meta;
    document.getElementById("metaTop").textContent = meta;
  }

  // ---------- offset + plan ----------
  let offset = NaN;

  function calcProp(){
    const e = n(document.getElementById("entryF").value);
    const s = n(document.getElementById("slF").value);
    const tp = n(document.getElementById("tpF").value);

    if(!isNum(offset)){
      document.getElementById("entryP").textContent = "—";
      document.getElementById("slP").textContent = "—";
      document.getElementById("tpP").textContent = "—";
      updateKPIs();
      return;
    }

    document.getElementById("entryP").textContent = isNum(e) ? fmt2(e + offset) : "—";
    document.getElementById("slP").textContent    = isNum(s) ? fmt2(s + offset) : "—";
    document.getElementById("tpP").textContent    = isNum(tp) ? fmt2(tp + offset) : "—";

    updateKPIs();
  }

  document.getElementById("setOffset").addEventListener("click", () => {
    const f = n(document.getElementById("futureNow").value);
    const p = n(document.getElementById("propNow").value);
    if (isNum(f) && isNum(p)) {
      offset = p - f;
      document.getElementById("offsetVal").textContent = fmt2(offset);
      calcProp();
      autoSave(true);
    }
  });

  ["futureNow","propNow","entryF","slF","tpF"].forEach(id=>{
    document.getElementById(id).addEventListener("input", () => { calcProp(); autoSave(true); });
  });

  async function copyVal(v){
    if(!v || v === "—") return;
    try { await navigator.clipboard.writeText(v); } catch {}
  }
  document.getElementById("copyEntry").addEventListener("click", ()=>copyVal(document.getElementById("entryP").textContent));
  document.getElementById("copySL").addEventListener("click", ()=>copyVal(document.getElementById("slP").textContent));
  document.getElementById("copyTP").addEventListener("click", ()=>copyVal(document.getElementById("tpP").textContent));

  // ---------- tabs ----------
  const tabChart = document.getElementById("tabChart");
  const tabNotes = document.getElementById("tabNotes");
  const panelChart = document.getElementById("panelChart");
  const panelNotes = document.getElementById("panelNotes");
  function setTab(which){
    const chart = which === "chart";
    tabChart.classList.toggle("active", chart);
    tabNotes.classList.toggle("active", !chart);
    panelChart.classList.toggle("hidden", !chart);
    panelNotes.classList.toggle("hidden", chart);
  }
  tabChart.addEventListener("click", ()=>setTab("chart"));
  tabNotes.addEventListener("click", ()=>setTab("notes"));

  // ---------- tradingview embed ----------
  let tvInterval = "15";
  function renderTV(){
    const script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
    script.async = true;
    script.textContent = JSON.stringify({
      autosize: true,
      symbol: tvSymbol,
      interval: tvInterval,
      timezone: "Europe/Berlin",
      theme: "dark",
      style: "1",
      locale: "en",
      allow_symbol_change: false,
      calendar: false,
      hide_top_toolbar: false,
      hide_legend: false,
      support_host: "https://www.tradingview.com"
    });
    const container = document.getElementById("tv_chart");
    container.innerHTML = "";
    container.appendChild(script);
  }
  function setTF(tf){
    tvInterval = tf;
    document.querySelectorAll("#tfRow .pill").forEach(p=>{
      p.classList.toggle("active", p.getAttribute("data-tf") === tf);
    });
    renderTV();
  }
  document.querySelectorAll("#tfRow .pill").forEach(p=>{
    p.addEventListener("click", ()=>setTF(p.getAttribute("data-tf")));
  });
  renderTV();

  // ---------- Notes automation ----------
  const editor = document.getElementById("editor");

  function detectDirection(){
    const e = n(document.getElementById("entryF").value);
    const s = n(document.getElementById("slF").value);
    if(!isNum(e) || !isNum(s)) return null;
    if(e > s) return "long";
    if(e < s) return "short";
    return null;
  }
  function getDirection(){
    const sel = document.getElementById("jDir").value;
    if(sel !== "auto") return sel;
    const d = detectDirection();
    return d || "auto";
  }

  function updateKPIs(){
    const e = n(document.getElementById("entryF").value);
    const s = n(document.getElementById("slF").value);
    const tp = n(document.getElementById("tpF").value);

    const risk = (isNum(e) && isNum(s)) ? Math.abs(e - s) : NaN;
    const reward = (isNum(e) && isNum(tp)) ? Math.abs(tp - e) : NaN;
    const rmult = (isNum(risk) && risk > 0 && isNum(reward)) ? (reward / risk) : NaN;

    document.getElementById("kRisk").textContent = fmt2(risk);
    document.getElementById("kReward").textContent = fmt2(reward);

    const rEl = document.getElementById("kRmult");
    rEl.textContent = isNum(rmult) ? rmult.toFixed(2) + "R" : "—";
    rEl.classList.remove("good","bad");
    if(isNum(rmult)){
      if(rmult >= 2) rEl.classList.add("good");
      else if(rmult < 1) rEl.classList.add("bad");
    }

    document.getElementById("kOffset").textContent = fmt2(isNum(offset) ? offset : NaN);
    document.getElementById("dirWarn").style.display = isInverted ? "block" : "none";
  }

  // ---------- stars ----------
  let rating = 0;
  function renderStars(){
    const wrap = document.getElementById("stars");
    wrap.innerHTML = "";
    for(let i=1;i<=5;i++){
      const s = document.createElement("div");
      s.className = "star" + (i<=rating ? " active" : "");
      s.textContent = "★";
      s.addEventListener("click", ()=>{
        rating = i;
        document.getElementById("ratingText").textContent = rating + "/5";
        renderStars();
        autoSave(true);
      });
      wrap.appendChild(s);
    }
    document.getElementById("ratingText").textContent = rating ? (rating + "/5") : "—";
  }
  renderStars();

  // ---------- playbook form ----------
  const PLAYBOOK = [
    { id:"pb_pos_htf", title:"1) Position im HTF", opts:["sehr teuer","teuer","Gleichgewicht","günstig","sehr günstig"] },
    { id:"pb_trend_htf", title:"2) HTF Trend", opts:["long","short","seitwärts"] },
    { id:"pb_ltf_entry", title:"3) Einstieg auf dem LTF gefunden?", opts:["ja","nein"] },
    { id:"pb_leave_htf", title:"4a) Zone im HTF verlassen", opts:["explosiv","entschlossen","unentschlossen"] },
    { id:"pb_leave_ltf", title:"4b) Zone im LTF verlassen", opts:["explosiv","entschlossen","unentschlossen"] },
    { id:"pb_base", title:"5) Kerzen in der Basis", opts:["0-3","3-5","6+"] },
    { id:"pb_original", title:"6) Originalität", opts:["ja","nein"] },
    { id:"pb_flip", title:"7) Flipzone", opts:["ja","nein"] },
    { id:"pb_crv", title:"8) CRV", opts:["2:1","3:1","4:1","4:1+"] },
    { id:"pb_tested_ext", title:"9) Erweiterte Version getestet?", opts:["ja","nein","ja, aber weniger als 25%"] },
    { id:"pb_into_zone", title:"10) Markt kommt in die Zone", opts:["explosiv","steil","stufenartig"] },
    { id:"pb_twin", title:"11) Zwillingszone", opts:["ja","nein"] },
    { id:"pb_form", title:"12) Formation", opts:["ABA","ABF","FBF","FBA"] },
    { id:"pb_idea", title:"13) Tradeidee", opts:["meine eigene","Mentorentrade"] },
  ];

  const pbState = {}; // id -> selected string

  function renderPlaybook(){
    const grid = document.getElementById("pbGrid");
    grid.innerHTML = "";
    PLAYBOOK.forEach(item=>{
      const card = document.createElement("div");
      card.className = "pbCard";

      const t = document.createElement("div");
      t.className = "pbTitle";
      t.textContent = item.title;
      card.appendChild(t);

      const opts = document.createElement("div");
      opts.className = "pbOpts";

      item.opts.forEach(opt=>{
        const lab = document.createElement("label");
        lab.className = "opt";

        const rb = document.createElement("input");
        rb.type = "radio";
        rb.name = item.id;
        rb.value = opt;
        rb.checked = (pbState[item.id] === opt);
        rb.addEventListener("change", ()=>{
          pbState[item.id] = opt;
          // sync CRV dropdown too if pb_crv changes
          if(item.id === "pb_crv"){
            document.getElementById("jCrv").value = opt;
          }
          autoSave(true);
        });

        const span = document.createElement("span");
        span.textContent = opt;

        lab.appendChild(rb);
        lab.appendChild(span);
        opts.appendChild(lab);
      });

      card.appendChild(opts);
      grid.appendChild(card);
    });
  }
  renderPlaybook();

  // sync jCrv dropdown -> pb_crv
  document.getElementById("jCrv").addEventListener("change", ()=>{
    const v = document.getElementById("jCrv").value;
    if(v){
      pbState["pb_crv"] = v;
      renderPlaybook();
    }
    autoSave(true);
  });

  // ---------- image slots ----------
  const IMG_SLOTS = [
    {id:"imgD",  label:"Daily screenshot"},
    {id:"img4H", label:"4H screenshot"},
    {id:"img1H", label:"1H screenshot"},
    {id:"img15", label:"15m screenshot"},
  ];
  const images = {}; // id -> dataUrl

  function renderImages(){
    const grid = document.getElementById("imgGrid");
    grid.innerHTML = "";

    IMG_SLOTS.forEach(slot=>{
      const box = document.createElement("div");
      box.className = "imgSlot";

      const cap = document.createElement("div");
      cap.className="cap";
      cap.textContent = slot.label;
      box.appendChild(cap);

      const help = document.createElement("div");
      help.className="help";
      help.textContent = "Drop image here oder Upload. (Wird lokal gespeichert)";
      box.appendChild(help);

      const actions = document.createElement("div");
      actions.className = "imgActions";

      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "image/*";
      inp.style.display="none";

      const btnUp = document.createElement("button");
      btnUp.type="button";
      btnUp.className="mini";
      btnUp.textContent="Upload";
      btnUp.addEventListener("click", ()=>inp.click());

      const btnClear = document.createElement("button");
      btnClear.type="button";
      btnClear.className="mini";
      btnClear.textContent="Clear";
      btnClear.addEventListener("click", ()=>{
        delete images[slot.id];
        renderImages();
        autoSave(true);
      });

      actions.appendChild(btnUp);
      actions.appendChild(btnClear);
      box.appendChild(actions);

      inp.addEventListener("change", async ()=>{
        const f = inp.files && inp.files[0];
        if(!f) return;
        const data = await compressImageToDataURL(f, 1400, 0.82);
        images[slot.id] = data;
        renderImages();
        autoSave(true);
      });

      box.addEventListener("dragover", (e)=>{ e.preventDefault(); box.classList.add("drag"); });
      box.addEventListener("dragleave", ()=>box.classList.remove("drag"));
      box.addEventListener("drop", async (e)=>{
        e.preventDefault();
        box.classList.remove("drag");
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        if(!f.type.startsWith("image/")) return;
        const data = await compressImageToDataURL(f, 1400, 0.82);
        images[slot.id] = data;
        renderImages();
        autoSave(true);
      });

      if(images[slot.id]){
        const img = document.createElement("img");
        img.src = images[slot.id];
        box.appendChild(img);
        help.textContent = "Saved ✓ (lokal)";
      }

      box.appendChild(inp);
      grid.appendChild(box);
    });
  }

  async function compressImageToDataURL(file, maxDim=1400, quality=0.82){
    const blobURL = URL.createObjectURL(file);
    const img = await new Promise((res, rej)=>{
      const im = new Image();
      im.onload = ()=>res(im);
      im.onerror = rej;
      im.src = blobURL;
    });

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;

    let nw = w, nh = h;
    if(Math.max(w,h) > maxDim){
      const scale = maxDim / Math.max(w,h);
      nw = Math.round(w * scale);
      nh = Math.round(h * scale);
    }

    const canvas = document.createElement("canvas");
    canvas.width = nw;
    canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);

    URL.revokeObjectURL(blobURL);
    return canvas.toDataURL("image/jpeg", quality);
  }
  renderImages();

  // ---------- storage ----------
  function storageKey(){
    return `contractx.journal.v3.${brokerVal()}.${sym}`;
  }

  function computeSummary(){
    const e = n(document.getElementById("entryF").value);
    const s = n(document.getElementById("slF").value);
    const tp = n(document.getElementById("tpF").value);

    const risk = (isNum(e) && isNum(s)) ? Math.abs(e - s) : NaN;
    const reward = (isNum(e) && isNum(tp)) ? Math.abs(tp - e) : NaN;
    const rmult = (isNum(risk) && risk > 0 && isNum(reward)) ? (reward / risk) : NaN;

    const riskCash = n(document.getElementById("jRiskUsd").value);

    return {
      direction: getDirection(),
      risk: isNum(risk) ? risk : null,
      reward: isNum(reward) ? reward : null,
      rmult: isNum(rmult) ? rmult : null,
      offset: isNum(offset) ? offset : null,
      riskCash: isNum(riskCash) ? riskCash : null,
      crv: document.getElementById("jCrv").value || (pbState["pb_crv"] || ""),
      prop: {
        entry: document.getElementById("entryP").textContent || "—",
        sl:    document.getElementById("slP").textContent || "—",
        tp:    document.getElementById("tpP").textContent || "—",
      },
      playbook: pbState
    };
  }

  function save(silent=false){
    const payload = {
      ts: Date.now(),
      date: document.getElementById("jDate").value.trim(),
      tags: document.getElementById("jTags").value.trim(),
      bias: document.getElementById("jBias").value.trim(),
      dir:  document.getElementById("jDir").value,
      rating,
      riskCash: document.getElementById("jRiskUsd").value.trim(),
      crv: document.getElementById("jCrv").value || "",
      playbook: pbState,
      text: editor.innerText || "",
      images,
      offset: isNum(offset) ? offset : null,
      computed: computeSummary()
    };
    localStorage.setItem(storageKey(), JSON.stringify(payload));
    document.getElementById("jStatus").textContent = silent ? "Autosaved ✓" : "Saved ✓";
  }

  let saveTimer = null;
  function autoSave(silent=true){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>save(silent), 350);
  }

  function load(){
    setMeta();
    updateKPIs();

    const raw = localStorage.getItem(storageKey());
    if(!raw){
      document.getElementById("jStatus").textContent = "No saved journal yet.";
      return;
    }
    try{
      const d = JSON.parse(raw);
      document.getElementById("jDate").value = d.date || "";
      document.getElementById("jTags").value = d.tags || "";
      document.getElementById("jBias").value = d.bias || "";
      document.getElementById("jDir").value  = d.dir || "auto";
      document.getElementById("jRiskUsd").value = d.riskCash || "";
      document.getElementById("jCrv").value = d.crv || "";

      rating = d.rating || 0;
      renderStars();

      // playbook
      for(const k in pbState) delete pbState[k];
      if(d.playbook){
        for(const k in d.playbook) pbState[k] = d.playbook[k];
      }
      // ensure CRV sync
      if(document.getElementById("jCrv").value){
        pbState["pb_crv"] = document.getElementById("jCrv").value;
      }
      renderPlaybook();

      editor.textContent = d.text || "";

      if(d.images){
        for(const k in d.images) images[k] = d.images[k];
      }
      renderImages();

      if(typeof d.offset === "number" && isNum(d.offset)){
        offset = d.offset;
        document.getElementById("offsetVal").textContent = fmt2(offset);
      }

      document.getElementById("jStatus").textContent =
        `Loaded ✓ (${new Date(d.ts || Date.now()).toLocaleString()})`;
    } catch {
      document.getElementById("jStatus").textContent = "Load failed (invalid storage).";
    }
  }

  function clearAll(){
    localStorage.removeItem(storageKey());
    document.getElementById("jDate").value = "";
    document.getElementById("jTags").value = "";
    document.getElementById("jBias").value = "";
    document.getElementById("jDir").value = "auto";
    document.getElementById("jRiskUsd").value = "";
    document.getElementById("jCrv").value = "";
    editor.textContent = "";
    rating = 0; renderStars();

    for(const k in pbState) delete pbState[k];
    renderPlaybook();

    for(const k in images) delete images[k];
    renderImages();

    document.getElementById("jStatus").textContent = "Cleared.";
  }

  // ---------- summary insertion ----------
  function insertSummary(){
    const sum = computeSummary();
    const date = document.getElementById("jDate").value.trim() || "-";
    const tags = document.getElementById("jTags").value.trim() || "-";
    const bias = document.getElementById("jBias").value.trim() || "-";
    const dir = sum.direction || "auto";
    const rtxt = sum.rmult != null ? sum.rmult.toFixed(2) + "R" : "—";
    const risk = sum.risk != null ? fmt2(sum.risk) : "—";
    const reward = sum.reward != null ? fmt2(sum.reward) : "—";
    const off = sum.offset != null ? fmt2(sum.offset) : "—";
    const cash = sum.riskCash != null ? ("$" + fmt2(sum.riskCash)) : "—";

    const inv = isInverted ? " (INVERTED FX: Future short = FX long)" : "";

    const pbLines = PLAYBOOK.map(it=>{
      const v = pbState[it.id] || "—";
      return `- ${it.title.replace(/^\d+\)\s*/,'')}: ${v}`;
    }).join("\n");

    const block =
`=== CONTRACTX SUMMARY ===
Instrument: ${sym} • Broker: ${brokerVal()}${inv}
Date/Session: ${date}
Tags: ${tags}
Bias/Plan: ${bias}
Direction: ${dir}
Risk-$: ${cash}
Risk: ${risk} • Reward: ${reward} • R: ${rtxt}
CRV: ${sum.crv || "—"}
Offset (Prop−Future): ${off}
Prop Entry/SL/TP: ${sum.prop.entry} / ${sum.prop.sl} / ${sum.prop.tp}

Playbook:
${pbLines}
`;

    const cur = editor.innerText || "";
    editor.textContent = (cur ? (cur + "\n\n") : "") + block;
    autoSave(true);
  }

  // ---------- pdf / print ----------
  function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const margin = 46;
    const pageW = 595;
    const pageH = 842;
    let y = 56;

    const sum = computeSummary();
    const date = document.getElementById("jDate").value.trim();
    const tags = document.getElementById("jTags").value.trim();
    const bias = document.getElementById("jBias").value.trim();
    const notesText = (editor.innerText || "").trim() || "-";

    doc.setFont("helvetica","bold"); doc.setFontSize(18);
    doc.text("CONTRACTX — Journal", margin, y);

    y += 22;
    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    doc.text(`Instrument: ${sym}`, margin, y); y += 16;
    doc.text(`Broker: ${brokerVal()}`, margin, y); y += 16;
    doc.text(`Chart Proxy: ${tvSymbol}`, margin, y); y += 16;

    y += 8;
    doc.setFont("helvetica","bold"); doc.text("Trade Data", margin, y); y += 16;
    doc.setFont("helvetica","normal");

    const off = sum.offset != null ? fmt2(sum.offset) : "—";
    const risk = sum.risk != null ? fmt2(sum.risk) : "—";
    const reward = sum.reward != null ? fmt2(sum.reward) : "—";
    const rmult = sum.rmult != null ? (sum.rmult.toFixed(2) + "R") : "—";
    const cash = sum.riskCash != null ? ("$" + fmt2(sum.riskCash)) : "—";

    doc.text(`Direction: ${sum.direction || "-"}`, margin, y); y += 16;
    doc.text(`Risk-$: ${cash}`, margin, y); y += 16;
    doc.text(`Risk: ${risk}    Reward: ${reward}    R-Multiple: ${rmult}`, margin, y); y += 16;
    doc.text(`CRV: ${sum.crv || "—"}`, margin, y); y += 16;
    doc.text(`Offset (Prop − Future): ${off}`, margin, y); y += 16;
    doc.text(`Prop Entry/SL/TP: ${sum.prop.entry} / ${sum.prop.sl} / ${sum.prop.tp}`, margin, y); y += 18;

    if(isInverted){
      doc.setFont("helvetica","bold");
      doc.text("INVERTED FX: Future short = FX long (und umgekehrt).", margin, y);
      doc.setFont("helvetica","normal");
      y += 18;
    }

    y += 6;
    doc.setFont("helvetica","bold"); doc.text("Context", margin, y); y += 16;
    doc.setFont("helvetica","normal");
    doc.text(`Datum/Session: ${date || "-"}`, margin, y); y += 16;
    doc.text(`Setup/Tags: ${tags || "-"}`, margin, y); y += 16;
    doc.text(`Bias/Plan: ${bias || "-"}`, margin, y); y += 18;

    y += 6;
    doc.setFont("helvetica","bold"); doc.text("Playbook", margin, y); y += 16;
    doc.setFont("helvetica","normal");
    const pbText = PLAYBOOK.map(it=>{
      const v = pbState[it.id] || "-";
      return `${it.title.replace(/^\d+\)\s*/,'')}: ${v}`;
    }).join("\n");
    const maxWidth = pageW - margin*2;
    const pbLines = doc.splitTextToSize(pbText, maxWidth);
    doc.text(pbLines, margin, y);
    y += 12 * pbLines.length + 16;

    y += 6;
    doc.setFont("helvetica","bold"); doc.text("Notes", margin, y); y += 16;
    doc.setFont("helvetica","normal");
    const noteLines = doc.splitTextToSize(notesText, maxWidth);
    doc.text(noteLines, margin, y);
    y += 12 * noteLines.length + 16;

    // Images
    const imgs = IMG_SLOTS.map(s=>({label:s.label, data:images[s.id]})).filter(x=>!!x.data);
    for(const im of imgs){
      if(y > pageH - 220){
        doc.addPage();
        y = 56;
      }
      doc.setFont("helvetica","bold"); doc.setFontSize(12);
      doc.text(im.label, margin, y); y += 10;

      const imgW = pageW - margin*2;
      const imgH = 320;

      try{
        doc.addImage(im.data, "JPEG", margin, y, imgW, imgH);
        y += imgH + 16;
      } catch {
        doc.setFont("helvetica","normal"); doc.setFontSize(11);
        doc.text("(Image could not be embedded)", margin, y); y += 16;
      }
    }

    const safeDate = (date || new Date().toISOString().slice(0,10)).replace(/[^0-9A-Za-z_-]/g,"-");
    doc.save(`contractx-${sym}-${brokerVal()}-${safeDate}.pdf`);
  }

  function printNote(){
    const sum = computeSummary();
    const date = document.getElementById("jDate").value.trim();
    const tags = document.getElementById("jTags").value.trim();
    const bias = document.getElementById("jBias").value.trim();
    const notesText = (editor.innerText || "").trim() || "-";
    const esc = (s)=>String(s).replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c]));

    const pbHtml = PLAYBOOK.map(it=>{
      const v = pbState[it.id] || "-";
      return `<div><b>${esc(it.title.replace(/^\d+\)\s*/,''))}:</b> ${esc(v)}</div>`;
    }).join("");

    const imgs = IMG_SLOTS.map(s=>({label:s.label, data:images[s.id]})).filter(x=>!!x.data);
    const imgHtml = imgs.map(x=>`
      <div class="box">
        <b>${esc(x.label)}</b><br>
        <img src="${x.data}" style="width:100%;max-width:100%;border-radius:10px;margin-top:10px" />
      </div>
    `).join("");

    const html = `
      <html><head><meta charset="utf-8">
        <title>CONTRACTX Journal</title>
        <style>
          body{font-family:Arial,Helvetica,sans-serif;padding:24px;background:#fff;color:#111;}
          h1{margin:0 0 10px;}
          .muted{color:#666;font-size:12px;}
          .box{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:12px;}
          pre{white-space:pre-wrap;word-wrap:break-word;font-family:inherit;}
        </style>
      </head><body>
        <h1>CONTRACTX — Journal</h1>
        <div class="muted">Instrument: ${esc(sym)} • Broker: ${esc(brokerVal())} • Chart: ${esc(tvSymbol)}</div>

        <div class="box">
          <b>Trade Data</b><br>
          Direction: ${esc(sum.direction || "-")}<br>
          Risk-$: ${esc(sum.riskCash!=null?("$"+sum.riskCash.toFixed(2)):"—")}<br>
          Risk: ${esc(sum.risk!=null?sum.risk.toFixed(2):"—")} • Reward: ${esc(sum.reward!=null?sum.reward.toFixed(2):"—")} • R: ${esc(sum.rmult!=null?(sum.rmult.toFixed(2)+"R"):"—")}<br>
          CRV: ${esc(sum.crv || "—")}<br>
          Offset (Prop−Future): ${esc(sum.offset!=null?sum.offset.toFixed(2):"—")}<br>
          Prop Entry/SL/TP: ${esc(sum.prop.entry)} / ${esc(sum.prop.sl)} / ${esc(sum.prop.tp)}<br>
          ${isInverted ? "<br><b>INVERTED FX:</b> Future short = FX long (und umgekehrt)." : ""}
        </div>

        <div class="box">
          <b>Context</b><br>
          Datum/Session: ${esc(date || "-")}<br>
          Setup/Tags: ${esc(tags || "-")}<br>
          Bias/Plan: ${esc(bias || "-")}
        </div>

        <div class="box">
          <b>Playbook</b><br>
          ${pbHtml}
        </div>

        <div class="box">
          <b>Notes</b>
          <pre>${esc(notesText)}</pre>
        </div>

        ${imgHtml}

        <script>window.onload=()=>window.print();<\/script>
      </body></html>
    `;

    const w = window.open("", "_blank");
    if(!w) return;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // ---------- events ----------
  document.getElementById("btnInsertBlock").addEventListener("click", insertSummary);
  document.getElementById("btnSave").addEventListener("click", ()=>save(false));
  document.getElementById("btnClear").addEventListener("click", clearAll);
  document.getElementById("btnPdf").addEventListener("click", exportPDF);
  document.getElementById("btnPrint").addEventListener("click", printNote);

  // autosave hooks
  const autos = ["jDate","jTags","jBias","jDir","jRiskUsd","jCrv"];
  autos.forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{ updateKPIs(); autoSave(true); });
    document.getElementById(id).addEventListener("change", ()=>{ updateKPIs(); autoSave(true); });
  });
  editor.addEventListener("input", ()=>autoSave(true));

  document.getElementById("broker").addEventListener("change", ()=>{
    setMeta();
    load();
    autoSave(true);
  });

  // ---------- init ----------
  setMeta();
  updateKPIs();
  load();
  calcProp();
</script>

</body>
</html>
