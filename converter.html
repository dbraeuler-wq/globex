<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTRACTX — Converter</title>

  <style>
    :root{
      --bg:#070A0F;
      --stroke:rgba(255,255,255,.12);
      --stroke2:rgba(255,255,255,.22);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.65);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --warn:#FFD66E;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(40,110,255,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(255,215,80,.12), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:22px;
    }
    h1{margin:0;font-size:26px}
    .sub{margin-top:6px;font-size:13px;color:var(--muted)}

    .row{
      margin-top:18px;
      display:grid;
      grid-template-columns:1.05fr .95fr;
      gap:14px;
    }
    @media(max-width:900px){.row{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.25);
      padding:16px;
    }

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background:rgba(0,0,0,.35);
      color:var(--text);
      font-size:15px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(234,240,255,.35)}
    textarea{resize:vertical;font-size:14px;line-height:1.4}

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.two{grid-template-columns:1fr}}

    .btn{
      margin-top:10px;
      padding:11px 14px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      transition:.15s ease;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}

    .big{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:16px;
      background:rgba(0,0,0,.35);
    }
    .big .t{font-size:12px;color:var(--muted)}
    .big .v{font-size:28px;font-weight:900;margin-top:6px}

    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:520px){.kv{grid-template-columns:1fr}}

    .note{margin-top:12px;font-size:12px;color:var(--muted);line-height:1.45}
    .warn{
      margin-top:12px;
      border:1px solid rgba(255,214,110,.35);
      background:rgba(255,214,110,.08);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:var(--warn);
    }

    .tvbox{
      height:560px;
      border-radius:16px;
      overflow:hidden;
    }
  </style>

  <!-- jsPDF (PDF Download) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <section class="panel">
      <h1 id="title">CONTRACTX Converter</h1>
      <div class="sub">
        Links: Future + Prop-Mid zur Kalibrierung (Offset). Darunter Entry/SL/TP in Future-Preisen.
        Rechts: fertige Prop-Preise zum Kopieren. Unten: Live-Chart (TradingView Proxy) + Journal + PDF.
      </div>

      <div class="row">
        <!-- LEFT -->
        <div class="card">
          <div class="two">
            <div>
              <label>Broker</label>
              <select id="broker">
                <option>CampusFund</option>
                <option>FTMO</option>
                <option>FundingPips</option>
              </select>
            </div>
            <div>
              <label>Mode</label>
              <select id="mode">
                <option value="auto">Auto</option>
                <option value="fx">FX</option>
                <option value="offset">Offset</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Future aktuell (TradingView)</label>
              <input id="futureNow" inputmode="decimal" placeholder="z. B. 49308.45">
            </div>
            <div>
              <label>Prop aktuell (Mid)</label>
              <input id="propNow" inputmode="decimal" placeholder="z. B. 49310.65">
            </div>
          </div>

          <button class="btn" id="setOffset" type="button">Set Offset</button>

          <div class="note">
            Offset (Prop − Future): <strong id="offsetVal">—</strong>
          </div>

          <div style="margin-top:14px">
            <label>Trade-Plan (Future)</label>
            <div class="two">
              <div>
                <label style="margin-top:0">Entry</label>
                <input id="entryF" inputmode="decimal" placeholder="Entry (Future)">
              </div>
              <div>
                <label style="margin-top:0">SL</label>
                <input id="slF" inputmode="decimal" placeholder="SL (Future)">
              </div>
            </div>
            <div style="margin-top:10px">
              <label>TP</label>
              <input id="tpF" inputmode="decimal" placeholder="TP (Future)">
            </div>
          </div>

          <div class="note">
            Tipp: Prop Mid = (Bid + Ask) / 2. Offset ist session-/brokerabhängig.
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <div class="big">
            <div class="t">Prop Entry</div>
            <div class="v" id="entryP">—</div>
            <button class="btn" type="button" id="copyEntry">Copy Entry</button>
          </div>

          <div class="kv">
            <div class="big">
              <div class="t">Prop SL</div>
              <div class="v" id="slP">—</div>
              <button class="btn" type="button" id="copySL">Copy SL</button>
            </div>
            <div class="big">
              <div class="t">Prop TP</div>
              <div class="v" id="tpP">—</div>
              <button class="btn" type="button" id="copyTP">Copy TP</button>
            </div>
          </div>

          <div class="warn" id="invertHint" style="display:none">
            ⚠️ Dieses FX-Pair ist <strong>invertiert</strong><br>
            <strong>Future SHORT = FX LONG</strong><br>
            <strong>Future LONG = FX SHORT</strong>
          </div>

          <div class="note" id="chartNote"></div>
        </div>
      </div>

      <!-- CHART -->
      <div class="card" style="margin-top:16px">
        <div class="note" style="margin-top:0">Live Chart (TradingView)</div>
        <div class="tvbox">
          <div class="tradingview-widget-container" style="height:100%;width:100%">
            <div id="tv_chart" style="height:100%;width:100%"></div>
          </div>
        </div>
      </div>

      <!-- JOURNAL -->
      <div class="card" style="margin-top:16px">
        <div class="note" style="margin-top:0">Journal (lokal gespeichert)</div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Datum / Session</label>
            <input id="jDate" placeholder="z. B. 2026-01-24 / NY Open">
          </div>
          <div>
            <label>Setup / Tags</label>
            <input id="jTags" placeholder="z. B. Globex Trap, A+, Sweep, S/D">
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Bias / Plan</label>
            <input id="jBias" placeholder="z. B. Short unter Vortages-High, Ziel EQ">
          </div>
          <div>
            <label>Instrument / Broker</label>
            <input id="jMeta" readonly>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Notizen</label>
          <textarea id="jNotes" rows="8" placeholder="Dein kurzer Trade-Journal-Text..."></textarea>
        </div>

        <div class="two" style="margin-top:10px">
          <button class="btn" id="jSave" type="button">Save Notes</button>
          <button class="btn" id="jClear" type="button">Clear Notes</button>
        </div>

        <div class="two" style="margin-top:10px">
          <button class="btn" id="jPdf" type="button">Download PDF</button>
          <button class="btn" id="jPrint" type="button">Print / Save as PDF</button>
        </div>

        <div class="note" id="jStatus"></div>
      </div>

    </section>
  </div>

<script>
  /** ========= SYMBOL NORMALIZE ========= **/
  const RAW = (new URLSearchParams(location.search).get("symbol") || "ES").toUpperCase().trim();
  const cleaned = RAW.replace(/[^A-Z0-9!]/g, "");

  function normalizeSymbol(s){
    if(!s) return "ES";
    if(s.startsWith("6")) return s.slice(0,2);        // 6E/6C/...
    const known3 = ["RTY"];
    const s3 = s.slice(0,3);
    if(known3.includes(s3)) return s3;
    return s.slice(0,2);                               // ES/NQ/YM/GC/CL/NG/SI
  }

  const sym = normalizeSymbol(cleaned);
  document.getElementById("title").textContent = sym + " — CONTRACTX Converter";

  /** ========= INVERT WARNING ========= **/
  const FX_INVERTED = ["6C","6J","6S"];
  if (FX_INVERTED.includes(sym)) {
    document.getElementById("invertHint").style.display = "block";
  }

  /** ========= CHART MAP (WIDGET-FRIENDLY) ========= **/
  const TV_MAP = {
    // Indizes: OANDA CFDs (funktionieren in Widgets zuverlässig)
    ES:  "OANDA:SPX500USD",
    NQ:  "OANDA:NAS100USD",
    YM:  "OANDA:US30USD",
    RTY: "OANDA:US2000USD",

    // Commodities: Proxies
    GC:  "TVC:GOLD",
    SI:  "TVC:SILVER",
    CL:  "TVC:USOIL",
    NG:  "TVC:NATGAS",

    // FX Spot
    "6E":"FX:EURUSD",
    "6B":"FX:GBPUSD",
    "6A":"FX:AUDUSD",
    "6N":"FX:NZDUSD",
    "6C":"FX:USDCAD",
    "6J":"FX:USDJPY",
    "6S":"FX:USDCHF"
  };

  const tvSymbol = TV_MAP[sym] || "OANDA:SPX500USD";
  document.getElementById("chartNote").textContent =
    `Chart: ${tvSymbol} (Proxy). Dein Offset-Mapping bleibt auf Futures-Preisen.`;

  /** ========= OFFSET + PLAN ========= **/
  function n(v){
    if(!v) return NaN;
    return Number(String(v).replace(",", ".").trim());
  }
  function fmt2(x){
    if(!isFinite(x)) return "—";
    return Number(x).toFixed(2);
  }

  let offset = NaN;

  document.getElementById("setOffset").addEventListener("click", () => {
    const f = n(document.getElementById("futureNow").value);
    const p = n(document.getElementById("propNow").value);
    if (isFinite(f) && isFinite(p)) {
      offset = p - f;
      document.getElementById("offsetVal").textContent = fmt2(offset);
      calc();
      // journal status update (optional)
      const st = document.getElementById("jStatus");
      if(st) st.textContent = st.textContent || "";
    }
  });

  function calc(){
    const e = n(document.getElementById("entryF").value);
    const s = n(document.getElementById("slF").value);
    const t = n(document.getElementById("tpF").value);

    if(!isFinite(offset)){
      document.getElementById("entryP").textContent = "—";
      document.getElementById("slP").textContent = "—";
      document.getElementById("tpP").textContent = "—";
      return;
    }

    document.getElementById("entryP").textContent = isFinite(e) ? fmt2(e + offset) : "—";
    document.getElementById("slP").textContent    = isFinite(s) ? fmt2(s + offset) : "—";
    document.getElementById("tpP").textContent    = isFinite(t) ? fmt2(t + offset) : "—";
  }

  ["futureNow","propNow","entryF","slF","tpF"].forEach(id=>{
    document.getElementById(id).addEventListener("input", calc);
  });

  async function copyVal(v){
    if(!v || v === "—") return;
    try { await navigator.clipboard.writeText(v); } catch {}
  }
  document.getElementById("copyEntry").addEventListener("click", ()=>copyVal(document.getElementById("entryP").textContent));
  document.getElementById("copySL").addEventListener("click", ()=>copyVal(document.getElementById("slP").textContent));
  document.getElementById("copyTP").addEventListener("click", ()=>copyVal(document.getElementById("tpP").textContent));

  /** ========= TRADINGVIEW EMBED (ADVANCED CHART) ========= **/
  (function renderTV(){
    const script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
    script.async = true;
    script.textContent = JSON.stringify({
      autosize: true,
      symbol: tvSymbol,
      interval: "5",
      timezone: "Europe/Berlin",
      theme: "dark",
      style: "1",
      locale: "en",
      allow_symbol_change: false,
      calendar: false,
      hide_top_toolbar: false,
      hide_legend: false,
      support_host: "https://www.tradingview.com"
    });

    const container = document.getElementById("tv_chart");
    container.innerHTML = "";
    container.appendChild(script);
  })();

  /** ========= JOURNAL (localStorage + PDF) ========= **/
  function journalKey(){
    const b = document.getElementById("broker")?.value || "Broker";
    return `contractx.journal.${b}.${sym}`;
  }

  function setJournalMeta(){
    const b = document.getElementById("broker")?.value || "Broker";
    const meta = `${sym} • ${b} • Chart: ${tvSymbol}`;
    const el = document.getElementById("jMeta");
    if(el) el.value = meta;
  }

  function loadJournal(){
    setJournalMeta();
    const raw = localStorage.getItem(journalKey());
    if(!raw){
      document.getElementById("jStatus").textContent = "No saved notes yet.";
      return;
    }
    try{
      const data = JSON.parse(raw);
      document.getElementById("jDate").value  = data.date || "";
      document.getElementById("jTags").value  = data.tags || "";
      document.getElementById("jBias").value  = data.bias || "";
      document.getElementById("jNotes").value = data.notes || "";
      document.getElementById("jStatus").textContent =
        `Loaded ✓ (${new Date(data.ts || Date.now()).toLocaleString()})`;
    } catch {
      document.getElementById("jStatus").textContent = "Load failed (invalid storage).";
    }
  }

  function saveJournal(silent=false){
    const data = {
      date:  document.getElementById("jDate").value.trim(),
      tags:  document.getElementById("jTags").value.trim(),
      bias:  document.getElementById("jBias").value.trim(),
      notes: document.getElementById("jNotes").value.trim(),
      ts: Date.now()
    };
    localStorage.setItem(journalKey(), JSON.stringify(data));
    document.getElementById("jStatus").textContent = silent ? "Autosaved ✓" : "Saved ✓";
  }

  function clearJournal(){
    localStorage.removeItem(journalKey());
    document.getElementById("jDate").value = "";
    document.getElementById("jTags").value = "";
    document.getElementById("jBias").value = "";
    document.getElementById("jNotes").value = "";
    document.getElementById("jStatus").textContent = "Cleared.";
  }

  function exportJournalPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const b = document.getElementById("broker")?.value || "Broker";
    const date = document.getElementById("jDate").value.trim();
    const tags = document.getElementById("jTags").value.trim();
    const bias = document.getElementById("jBias").value.trim();
    const notes = document.getElementById("jNotes").value.trim();

    const pEntry = document.getElementById("entryP")?.textContent || "—";
    const pSL = document.getElementById("slP")?.textContent || "—";
    const pTP = document.getElementById("tpP")?.textContent || "—";
    const off = document.getElementById("offsetVal")?.textContent || "—";

    const margin = 46;
    let y = 56;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("CONTRACTX — Journal", margin, y);

    y += 22;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Instrument: ${sym}`, margin, y); y += 16;
    doc.text(`Broker: ${b}`, margin, y); y += 16;
    doc.text(`Chart Proxy: ${tvSymbol}`, margin, y); y += 16;

    y += 8;
    doc.setFont("helvetica","bold");
    doc.text("Trade Data", margin, y); y += 16;
    doc.setFont("helvetica","normal");
    doc.text(`Offset (Prop − Future): ${off}`, margin, y); y += 16;
    doc.text(`Prop Entry: ${pEntry}    Prop SL: ${pSL}    Prop TP: ${pTP}`, margin, y); y += 18;

    y += 6;
    doc.setFont("helvetica","bold");
    doc.text("Session", margin, y); y += 16;
    doc.setFont("helvetica","normal");
    doc.text(`Datum/Session: ${date || "-"}`, margin, y); y += 16;
    doc.text(`Setup/Tags: ${tags || "-"}`, margin, y); y += 16;
    doc.text(`Bias/Plan: ${bias || "-"}`, margin, y); y += 18;

    y += 6;
    doc.setFont("helvetica","bold");
    doc.text("Notes", margin, y); y += 16;
    doc.setFont("helvetica","normal");

    const maxWidth = 595 - margin*2; // A4 width
    const lines = doc.splitTextToSize(notes || "-", maxWidth);
    doc.text(lines, margin, y);

    const safeDate = (date || new Date().toISOString().slice(0,10)).replace(/[^0-9A-Za-z_-]/g,"-");
    doc.save(`contractx-${sym}-${b}-${safeDate}.pdf`);
  }

  function printJournal(){
    const b = document.getElementById("broker")?.value || "Broker";
    const date = document.getElementById("jDate").value.trim();
    const tags = document.getElementById("jTags").value.trim();
    const bias = document.getElementById("jBias").value.trim();
    const notes = document.getElementById("jNotes").value.trim();

    const pEntry = document.getElementById("entryP")?.textContent || "—";
    const pSL = document.getElementById("slP")?.textContent || "—";
    const pTP = document.getElementById("tpP")?.textContent || "—";
    const off = document.getElementById("offsetVal")?.textContent || "—";

    const escapeHtml = (s) => String(s).replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c]));
    const html = `
      <html><head><meta charset="utf-8">
        <title>CONTRACTX Journal</title>
        <style>
          body{font-family:Arial,Helvetica,sans-serif;padding:24px;}
          h1{margin:0 0 10px;}
          .muted{color:#666;font-size:12px;}
          .box{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:12px;}
          pre{white-space:pre-wrap;word-wrap:break-word;font-family:inherit;}
        </style>
      </head><body>
        <h1>CONTRACTX — Journal</h1>
        <div class="muted">Instrument: ${escapeHtml(sym)} • Broker: ${escapeHtml(b)} • Chart: ${escapeHtml(tvSymbol)}</div>

        <div class="box">
          <b>Trade Data</b><br>
          Offset (Prop − Future): ${escapeHtml(off)}<br>
          Prop Entry: ${escapeHtml(pEntry)} • Prop SL: ${escapeHtml(pSL)} • Prop TP: ${escapeHtml(pTP)}
        </div>

        <div class="box">
          <b>Session</b><br>
          Datum/Session: ${escapeHtml(date || "-")}<br>
          Setup/Tags: ${escapeHtml(tags || "-")}<br>
          Bias/Plan: ${escapeHtml(bias || "-")}
        </div>

        <div class="box">
          <b>Notes</b>
          <pre>${escapeHtml(notes || "-")}</pre>
        </div>
        <script>window.onload=()=>window.print();</script>
      </body></html>
    `;
    const w = window.open("", "_blank");
    if(!w) return;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // Buttons
  document.getElementById("jSave").addEventListener("click", () => saveJournal(false));
  document.getElementById("jClear").addEventListener("click", clearJournal);
  document.getElementById("jPdf").addEventListener("click", exportJournalPDF);
  document.getElementById("jPrint").addEventListener("click", printJournal);

  // Auto-save on typing (optional)
  ["jDate","jTags","jBias","jNotes"].forEach(id=>{
    document.getElementById(id).addEventListener("input", () => saveJournal(true));
  });

  // Separate journal per broker
  document.getElementById("broker").addEventListener("change", () => {
    setJournalMeta();
    loadJournal();
  });

  // Init journal
  setJournalMeta();
  loadJournal();
</script>

</body>
</html>
